<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - User Management</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    :root {
      --primary-color: #e63946;
      --secondary-color: #457b9d;
      --accent-color: #1d3557;
      --light-color: #f1faee;
      --dark-color: #2b2d42;
      --success-color: #2a9d8f;
      --warning-color: #e9c46a;
      --danger-color: #e63946;
      --gray-light: #f8f9fa;
      --gray-medium: #e9ecef;
      --gray-dark: #495057;
    }
    
    body {
      background-color: #f8f9fc;
      color: var(--text-color);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .container {
      margin-top: 30px;
      max-width: 1200px;
    }
    
    .card {
      border: none;
      border-radius: 0.35rem;
      box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
      margin-bottom: 30px;
    }
    
    .card-header {
      background-color: var(--secondary-color);
      color: white;
      font-weight: 600;
      border-bottom: none;
      padding: 1rem 1.35rem;
      border-radius: 0.35rem 0.35rem 0 0 !important;
    }
    
    .table-responsive {
      overflow-x: auto;
    }
    
    .table {
      margin-bottom: 0;
    }
    
    .table th {
      border-top: none;
      font-weight: 600;
      color: #4e73df;
      padding: 1rem;
    }
    
    .table td {
      padding: 1rem;
      vertical-align: middle;
    }
    
    .btn-primary {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
    }
    
    .btn-primary:hover {
      background-color: var(--accent-color);
      border-color: var(--accent-color);
    }
    
    .form-control, .form-select {
      border-radius: 0.35rem;
      padding: 0.75rem 1rem;
      border: 1px solid #d1d3e2;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: #bac8f3;
      box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
    }
    
    .status-badge {
      padding: 0.35em 0.65em;
      font-size: 0.75em;
      font-weight: 700;
      border-radius: 0.25rem;
    }
    
    .badge-user {
      background-color: #36b9cc;
    }
    
    .badge-admin {
      background-color: #1cc88a;
    }
    
    .badge-superadmin {
      background-color: #f6c23e;
    }
    
    .action-buttons .btn {
      margin-right: 5px;
    }
    
    .search-box {
      position: relative;
      margin-bottom: 20px;
    }
    
    .search-box i {
      position: absolute;
      top: 12px;
      left: 12px;
      color: #d1d3e2;
    }
    
    .search-box input {
      padding-left: 35px;
    }
    
    .pagination .page-item.active .page-link {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
    }
    
    .pagination .page-link {
      color: var(--secondary-color);
    }
    
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1100;
    }
    
    .hidden { 
      display: none; 
    }
    
    .edit-form {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="{{ url_for('static', path='img/REDX Logo.png') }}" alt="REDX Logo" height="30" class="me-2">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin">User Management</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <span class="me-3 text-muted" id="currentUser"></span>
                    <a href="{{ url_for('logout') }}">
                    <button class="btn btn-outline-danger" id="logoutBtn">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </button>
                    </a>
                </div>
            </div>
        </div>
    </nav>
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="h4 text-gray-800"><i class="bi bi-people-fill me-2"></i>User Management Dashboard</h2>
    <div class="d-flex">
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
        <i class="bi bi-plus-circle me-1"></i> Add New User
      </button>
    </div>
  </div>

  <div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
      <h6 class="m-0 font-weight-bold text-white">User List</h6>
      <div class="search-box">
        <i class="bi bi-search"></i>
        <input type="text" class="form-control" id="searchInput" placeholder="Search users...">
      </div>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered" id="userTable" width="100%" cellspacing="0">
          <thead>
            <tr>
              <th>Username <i class="bi bi-arrow-down-up sort-icon" data-sort="username"></i></th>
              <th>Email <i class="bi bi-arrow-down-up sort-icon" data-sort="email"></i></th>
              <th>Role <i class="bi bi-arrow-down-up sort-icon" data-sort="role"></i></th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="userTableBody">
            <!-- Users will be loaded here -->
          </tbody>
        </table>
      </div>
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center" id="pagination">
          <!-- Pagination will be loaded here -->
        </ul>
      </nav>
    </div>
  </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="addUserForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <input type="text" class="form-control" id="username" required>
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" class="form-control" id="email" required>
          </div>
          <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input type="password" class="form-control" id="password" required>
          </div>
          <div class="mb-3">
            <label for="role" class="form-label">Role</label>
            <select class="form-select" id="role" required>
              <option value="user">User</option>
              <option value="admin">Admin</option>
              <option value="superadmin">Superadmin</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add User</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editUserForm">
        <div class="modal-body">
          <input type="hidden" id="editUsername">
          <div class="mb-3">
            <label for="editEmail" class="form-label">Email</label>
            <input type="email" class="form-control" id="editEmail" required>
          </div>
          <div class="mb-3">
            <label for="editRole" class="form-label">Role</label>
            <select class="form-select" id="editRole" required>
              <option value="user">User</option>
              <option value="admin">Admin</option>
              <option value="superadmin">Superadmin</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="editPassword" class="form-label">New Password (leave blank to keep current)</label>
            <input type="password" class="form-control" id="editPassword">
          </div>
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="editStatus">
            <label class="form-check-label" for="editStatus">Active</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div class="toast-container">
  <div class="toast align-items-center text-white bg-success" role="alert" aria-live="assertive" aria-atomic="true" id="successToast">
    <div class="d-flex">
      <div class="toast-body">
        <i class="bi bi-check-circle-fill me-2"></i>
        <span id="toastMessage">Operation completed successfully!</span>
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Global variables
let users = [];
let currentPage = 1;
const usersPerPage = 10;
let sortField = 'username';
let sortDirection = 'asc';
let searchQuery = '';

// DOM elements
const userTableBody = document.getElementById('userTableBody');
const pagination = document.getElementById('pagination');
const searchInput = document.getElementById('searchInput');
const sortIcons = document.querySelectorAll('.sort-icon');
const successToast = new bootstrap.Toast(document.getElementById('successToast'));


function handleUnauthorized() {
  showToast('Your session has expired. Please log in again.', 'danger');
  setTimeout(() => {
    window.location.href = '/'; // Redirect to home page after showing toast
  }, 2000);
}



// Get token from cookie
function getCookie(name) {
  const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  console.log(match);
  return match ? match[2] : null;
}

const token = getCookie('access_token_cookie');
console.log(token);
const headers = { 
  'Authorization': `Bearer ${token}`, 
  'Content-Type': 'application/json' 
};

// Fetch users from API
async function fetchUsers() {
  try {
    const response = await fetch('/users', { headers });

    if(response.status === 401){
      handleUnauthorized();
      return;
    }
    if (!response.ok) throw new Error('Failed to fetch users');
    
    users = await response.json();
    renderTable();
    renderPagination();
  } catch (error) {
    console.error('Error fetching users:', error);
    showToast('Error fetching users', 'danger');
  }
}

// Render user table
function renderTable() {
  // Filter users based on search query
  let filteredUsers = users.filter(user => 
    user.username.toLowerCase().includes(searchQuery.toLowerCase()) ||
    user.email.toLowerCase().includes(searchQuery.toLowerCase()) ||
    user.role.toLowerCase().includes(searchQuery.toLowerCase())
  );

  // Sort users
  filteredUsers.sort((a, b) => {
    if (a[sortField] < b[sortField]) return sortDirection === 'asc' ? -1 : 1;
    if (a[sortField] > b[sortField]) return sortDirection === 'asc' ? 1 : -1;
    return 0;
  });

  // Pagination
  const startIndex = (currentPage - 1) * usersPerPage;
  const paginatedUsers = filteredUsers.slice(startIndex, startIndex + usersPerPage);

  // Clear table
  userTableBody.innerHTML = '';

  // Add rows
  paginatedUsers.forEach(user => {
    const row = document.createElement('tr');
    
    // Determine status badge class
    let statusBadgeClass = 'badge-user';
    if (user.role === 'admin') statusBadgeClass = 'badge-admin';
    if (user.role === 'superadmin') statusBadgeClass = 'badge-superadmin';
    
    row.innerHTML = `
      <td>${user.username}</td>
      <td>${user.email}</td>
      <td><span class="status-badge ${statusBadgeClass}">${user.role}</span></td>
      <td>
        <span class="badge ${user.active ? 'bg-success' : 'bg-secondary'}">
          ${user.active ? 'Active' : 'Inactive'}
        </span>
      </td>
      <td class="action-buttons">
        <button class="btn btn-sm btn-warning" onclick="openEditModal('${user.username}')">
          <i class="bi bi-pencil"></i> Edit
        </button>
        <button class="btn btn-sm btn-danger" onclick="confirmDelete('${user.username}')">
          <i class="bi bi-trash"></i> Delete
        </button>
      </td>`;
    userTableBody.appendChild(row);
  });
}

// Render pagination
function renderPagination() {
  const filteredUsers = users.filter(user => 
    user.username.toLowerCase().includes(searchQuery.toLowerCase()) ||
    user.email.toLowerCase().includes(searchQuery.toLowerCase()) ||
    user.role.toLowerCase().includes(searchQuery.toLowerCase())
  );
  
  const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
  
  pagination.innerHTML = '';
  
  // Previous button
  pagination.innerHTML += `
    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
    </li>`;
  
  // Page numbers
  for (let i = 1; i <= totalPages; i++) {
    pagination.innerHTML += `
      <li class="page-item ${i === currentPage ? 'active' : ''}">
        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
      </li>`;
  }
  
  // Next button
  pagination.innerHTML += `
    <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
    </li>`;
}

// Change page
function changePage(page) {
  currentPage = page;
  renderTable();
}

// Sort table
function sortTable(field) {
  if (sortField === field) {
    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    sortField = field;
    sortDirection = 'asc';
  }
  
  // Update sort icons
  sortIcons.forEach(icon => {
    if (icon.dataset.sort === field) {
      icon.classList.toggle('bi-arrow-down', sortDirection === 'asc');
      icon.classList.toggle('bi-arrow-up', sortDirection === 'desc');
    } else {
      icon.classList.remove('bi-arrow-down', 'bi-arrow-up');
    }
  });
  
  renderTable();
}

// Search users
searchInput.addEventListener('input', () => {
  searchQuery = searchInput.value;
  currentPage = 1;
  renderTable();
  renderPagination();
});

// Add sort event listeners
sortIcons.forEach(icon => {
  icon.addEventListener('click', () => sortTable(icon.dataset.sort));
});

// Add new user
document.getElementById('addUserForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const user = {
    username: document.getElementById('username').value,
    email: document.getElementById('email').value,
    password: document.getElementById('password').value,
    role: document.getElementById('role').value,
    active: true
  };
  
  try {
    const response = await fetch('/users', {
      method: 'POST',
      headers,
      body: JSON.stringify(user)
    });

    if (response.status === 401) {
      handleUnauthorized();
      return;
    }
    
    if (!response.ok) throw new Error('Failed to add user');
    
    // Close modal and reset form
    const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
    modal.hide();
    e.target.reset();
    
    // Refresh user list
    await fetchUsers();
    showToast('User added successfully!');
  } catch (error) {
    console.error('Error adding user:', error);
    showToast('Error adding user', 'danger');
  }
});

// Open edit modal
async function openEditModal(username) {
  const user = users.find(u => u.username === username);
  if (!user) return;
  
  document.getElementById('editUsername').value = user.username;
  document.getElementById('editEmail').value = user.email;
  document.getElementById('editRole').value = user.role;
  document.getElementById('editStatus').checked = user.active;
  document.getElementById('editPassword').value = '';
  
  const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
  modal.show();
}

// Edit user
document.getElementById('editUserForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const username = document.getElementById('editUsername').value;
  const updateData = {
    email: document.getElementById('editEmail').value,
    role: document.getElementById('editRole').value,
    active: document.getElementById('editStatus').checked
  };
  
  const newPassword = document.getElementById('editPassword').value;
  if (newPassword) updateData.password = newPassword;
  
  try {
    const response = await fetch(`/users/${username}`, {
      method: 'PUT',
      headers,
      body: JSON.stringify(updateData)
    });
    
    if (response.status === 401) {
      handleUnauthorized();
      return;
    }
    if (!response.ok) throw new Error('Failed to update user');
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
    modal.hide();
    
    // Refresh user list
    await fetchUsers();
    showToast('User updated successfully!');
  } catch (error) {
    console.error('Error updating user:', error);
    showToast('Error updating user', 'danger');
  }
});

// Confirm delete
function confirmDelete(username) {
  if (confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
    deleteUser(username);
  }
}

// Delete user
async function deleteUser(username) {
  try {
    const response = await fetch(`/users/${username}`, {
      method: 'DELETE',
      headers
    });
    if (response.status === 401) {
      handleUnauthorized();
      return;
    }
    if (!response.ok) throw new Error('Failed to delete user');
    
    // Refresh user list
    await fetchUsers();
    showToast('User deleted successfully!');
  } catch (error) {
    console.error('Error deleting user:', error);
    showToast('Error deleting user', 'danger');
  }
}

// Show toast notification
function showToast(message, type = 'success') {
  const toast = document.getElementById('successToast');
  const toastMessage = document.getElementById('toastMessage');
  
  toastMessage.textContent = message;
  toast.className = `toast align-items-center text-white bg-${type}`;
  
  successToast.show();
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  
  fetchUsers();
  
  // Add event listener for modal hidden event to reset forms
  document.getElementById('addUserModal').addEventListener('hidden.bs.modal', () => {
    document.getElementById('addUserForm').reset();
  });
  
  document.getElementById('editUserModal').addEventListener('hidden.bs.modal', () => {
    document.getElementById('editUserForm').reset();
  });
});
</script>
</body>
</html>